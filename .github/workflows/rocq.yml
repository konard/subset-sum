name: Rocq Verification

on:
  push:
    branches: [ main ]
    paths:
      - '**.v'
      - '_CoqProject'
      - 'coq-*.opam'
      - '.github/workflows/rocq.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '**.v'
      - '_CoqProject'
      - 'coq-*.opam'
      - '.github/workflows/rocq.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check for Rocq files
      id: check-rocq
      run: |
        echo "=== Rocq Files Found ==="
        find . -name "*.v" -type f | sort
        if [ -f "_CoqProject" ] || find . -name "*.v" -print -quit | grep -q .; then
          echo "has_files=true" >> $GITHUB_OUTPUT
        else
          echo "has_files=false" >> $GITHUB_OUTPUT
          echo "No Rocq files found - skipping build"
          echo "To use Rocq verification, add Rocq source files (.v) and optionally a _CoqProject file"
        fi

    - name: Fix permissions for docker
      if: steps.check-rocq.outputs.has_files == 'true'
      run: sudo chown -R 1000:1000 .

    - name: Build Rocq project using docker-coq-action
      if: steps.check-rocq.outputs.has_files == 'true'
      uses: coq-community/docker-coq-action@v1
      with:
        custom_image: 'rocq/rocq-prover:9.0'
        custom_script: |
          startGroup "Rocq version"
            rocq --version
          endGroup
          startGroup "Verify Rocq files"
            if [ -f "_CoqProject" ]; then
              echo "Building Rocq project with _CoqProject..."
              rocq makefile -f _CoqProject -o Makefile.coq
              make -f Makefile.coq
            else
              echo "Verifying Rocq files..."
              find . -name "*.v" -type f | while read -r file; do
                echo "Checking: $file"
                rocq compile "$file" && echo "Verified: $file" || exit 1
              done
            fi
            echo "All Rocq files verified successfully!"
          endGroup

    - name: Revert permissions
      if: ${{ always() && steps.check-rocq.outputs.has_files == 'true' }}
      run: sudo chown -R 1001:116 .

    - name: Upload build logs
      if: always() && steps.check-rocq.outputs.has_files == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: rocq-logs
        path: |
          **/*.log
          **/*.vo
          **/*.glob
        retention-days: 7
